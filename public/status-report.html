<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Check Report - SPIDER</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .report-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .report-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .report-summary {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .summary-card {
            flex: 1;
            min-width: 100px;
            text-align: center;
            padding: 1rem;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        .summary-card.s2xx { background: var(--success-light); border-color: var(--success); }
        .summary-card.s3xx { background: var(--warning-light); border-color: var(--warning); }
        .summary-card.s4xx { background: #fef2f2; border-color: #fca5a5; }
        .summary-card.s5xx { background: var(--danger-light); border-color: var(--danger); }
        .summary-card.error { background: #fdf4ff; border-color: #d946ef; }
        .summary-card.progress { background: var(--accent-light); border-color: var(--accent-primary); }
        
        .summary-value {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .summary-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .filter-bar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-bar input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            font-family: inherit;
            font-size: 0.85rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }
        
        .filter-bar select {
            padding: 0.5rem 0.75rem;
            font-family: inherit;
            font-size: 0.85rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }
        
        .results-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .results-list {
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }
        
        .result-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }
        
        .result-row:hover {
            background: var(--bg-tertiary);
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-row.done {
            opacity: 0.6;
            background: var(--bg-tertiary);
        }
        
        .result-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--success);
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .result-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .result-status.s2xx { background: var(--success-light); color: var(--success); }
        .result-status.s3xx { background: var(--warning-light); color: var(--warning); }
        .result-status.s4xx { background: #fef2f2; color: #dc2626; }
        .result-status.s5xx { background: var(--danger-light); color: var(--danger); }
        .result-status.error { background: #fdf4ff; color: #d946ef; }
        .result-status.checking { background: var(--bg-tertiary); color: var(--text-muted); animation: pulse 1s infinite; }
        
        .recheck-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .recheck-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .recheck-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-change {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }
        
        .status-change.improved {
            color: var(--success);
        }
        
        .result-url {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
            word-break: break-all;
        }
        
        .result-url a {
            color: inherit;
            text-decoration: none;
        }
        
        .result-url a:hover {
            color: var(--accent-primary);
            text-decoration: underline;
        }
        
        .result-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .result-notes {
            flex-shrink: 0;
        }
        
        .result-notes input {
            width: 150px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }
        
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
            gap: 0.5rem;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .back-link:hover {
            color: var(--accent-primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0.5rem 1rem;
            }
            
            .logo-subtitle {
                display: none;
            }
            
            .report-container {
                padding: 1rem;
            }
            
            .report-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .report-title {
                font-size: 1.2rem;
            }
            
            .report-actions {
                flex-wrap: wrap;
            }
            
            .report-actions .btn {
                flex: 1;
                min-width: calc(50% - 0.25rem);
                justify-content: center;
            }
            
            .report-summary {
                flex-wrap: wrap;
            }
            
            .summary-card {
                flex: 1 1 calc(33.333% - 0.5rem);
                min-width: calc(33.333% - 0.5rem);
                padding: 0.5rem;
            }
            
            .summary-value {
                font-size: 1.25rem;
            }
            
            .summary-label {
                font-size: 0.6rem;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .filter-bar input,
            .filter-bar select {
                width: 100%;
                min-width: unset;
            }
            
            .results-list {
                max-height: none;
            }
            
            .result-row {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .result-checkbox {
                order: 0;
            }
            
            .result-status {
                order: 1;
            }
            
            .recheck-btn {
                order: 2;
            }
            
            .result-url {
                order: 4;
                width: 100%;
                font-size: 0.75rem;
            }
            
            .result-meta {
                order: 5;
                width: 100%;
                white-space: normal;
            }
            
            .result-notes {
                order: 6;
                width: 100%;
            }
            
            .result-notes input {
                width: 100%;
            }
            
            .empty-state {
                padding: 2rem 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .summary-card {
                flex: 1 1 calc(50% - 0.25rem);
                min-width: calc(50% - 0.25rem);
                padding: 0.625rem;
            }
            
            .summary-value {
                font-size: 1.1rem;
            }
            
            .summary-label {
                font-size: 0.55rem;
            }
            
            .report-title {
                font-size: 1rem;
            }
            
            .report-meta {
                font-size: 0.75rem;
            }
            
            .report-actions .btn {
                min-width: 100%;
            }
            
            .back-link {
                font-size: 0.8rem;
            }
            
            .result-status {
                font-size: 0.65rem;
                padding: 0.125rem 0.375rem;
            }
            
            .btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.625rem;
            }
            
            .btn svg {
                width: 12px;
                height: 12px;
            }
            
            .header {
                padding: 0.5rem 1rem;
            }
            
            .logo-text {
                font-size: 0.9rem;
            }
            
            .logo-subtitle {
                font-size: 0.65rem;
            }
        }
        
        /* Touch-friendly */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
            }
            
            .result-checkbox {
                width: 24px;
                height: 24px;
            }
            
            .recheck-btn {
                min-width: 44px;
                min-height: 44px;
                font-size: 1rem;
            }
            
            .result-notes input {
                min-height: 40px;
                font-size: 16px;
            }
            
            .filter-bar input,
            .filter-bar select {
                min-height: 44px;
                font-size: 16px;
            }
            
            .back-link {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
            }
            
            .result-row {
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üï∑Ô∏è</span>
                <span class="logo-text">SPIDER</span>
                <span class="logo-subtitle">Status Report</span>
            </div>
        </header>
        
        <div class="report-container">
            <a href="/" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15,18 9,12 15,6"/>
                </svg>
                Back to Tools
            </a>
            
            <div id="loading" class="loading">
                <span class="pulse-dot"></span>
                Loading report...
            </div>
            
            <div id="reportContent" style="display: none;">
                <div class="report-header">
                    <div>
                        <h1 class="report-title" id="reportTitle">Status Check Report</h1>
                        <div class="report-meta" id="reportMeta"></div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-ghost btn-sm" id="copyLinkBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy Link
                        </button>
                        <button class="btn btn-ghost btn-sm" id="exportCsvBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export CSV
                        </button>
                        <button class="btn btn-danger btn-sm" id="deleteReportBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"/>
                                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
                
                <div class="report-summary" id="reportSummary">
                    <div class="summary-card s2xx">
                        <span class="summary-value" id="sum2xx">0</span>
                        <span class="summary-label">2xx OK</span>
                    </div>
                    <div class="summary-card s3xx">
                        <span class="summary-value" id="sum3xx">0</span>
                        <span class="summary-label">3xx Redirect</span>
                    </div>
                    <div class="summary-card s4xx">
                        <span class="summary-value" id="sum4xx">0</span>
                        <span class="summary-label">4xx Not Found</span>
                    </div>
                    <div class="summary-card s5xx">
                        <span class="summary-value" id="sum5xx">0</span>
                        <span class="summary-label">5xx Error</span>
                    </div>
                    <div class="summary-card error">
                        <span class="summary-value" id="sumError">0</span>
                        <span class="summary-label">Errors</span>
                    </div>
                    <div class="summary-card progress">
                        <span class="summary-value" id="sumProgress">0/0</span>
                        <span class="summary-label">Done</span>
                    </div>
                </div>
                
                <div class="filter-bar">
                    <input type="text" id="filterInput" placeholder="üîç Filter by URL or status...">
                    <select id="filterStatus">
                        <option value="">All Status</option>
                        <option value="2xx">2xx Only</option>
                        <option value="3xx">3xx Redirects</option>
                        <option value="4xx">4xx Not Found</option>
                        <option value="5xx">5xx Errors</option>
                        <option value="error">Errors</option>
                    </select>
                    <select id="filterDone">
                        <option value="">All Items</option>
                        <option value="pending">Pending Only</option>
                        <option value="done">Done Only</option>
                    </select>
                </div>
                
                <div class="results-table">
                    <div class="results-list" id="resultsList"></div>
                </div>
            </div>
            
            <div id="errorState" class="empty-state" style="display: none;">
                <h3>Report not found</h3>
                <p>This report may have been deleted or the link is invalid.</p>
                <a href="/" class="btn btn-primary" style="margin-top: 1rem;">Go to Tools</a>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        let reportData = null;
        let reportId = null;
        
        // Get report ID from URL
        const params = new URLSearchParams(window.location.search);
        reportId = params.get('id');
        
        if (!reportId) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        } else {
            loadReport();
        }
        
        async function loadReport() {
            try {
                const response = await fetch(`/api/status-reports/${encodeURIComponent(reportId)}`);
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (!data.success || !data.report) {
                    document.getElementById('errorState').style.display = 'block';
                    return;
                }
                
                reportData = data.report;
                document.getElementById('reportContent').style.display = 'block';
                renderReport();
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }
        }
        
        function renderReport() {
            // Title and meta
            document.getElementById('reportTitle').textContent = reportData.name || 'Status Check Report';
            const date = new Date(reportData.createdAt);
            document.getElementById('reportMeta').textContent = `Created: ${date.toLocaleDateString()} ${date.toLocaleTimeString()} ‚Ä¢ ${reportData.results.length} URLs`;
            
            // Summary
            const sum = reportData.summary || {};
            document.getElementById('sum2xx').textContent = sum.s2xx || 0;
            document.getElementById('sum3xx').textContent = sum.s3xx || 0;
            document.getElementById('sum4xx').textContent = sum.s4xx || 0;
            document.getElementById('sum5xx').textContent = sum.s5xx || 0;
            document.getElementById('sumError').textContent = sum.error || 0;
            
            const stats = reportData.itemStats || { done: 0, total: reportData.results.length };
            document.getElementById('sumProgress').textContent = `${stats.done}/${stats.total}`;
            
            // Results
            renderResults(reportData.results);
        }
        
        function renderResults(results) {
            const list = document.getElementById('resultsList');
            
            if (!results || results.length === 0) {
                list.innerHTML = '<div class="empty-state">No results in this report</div>';
                return;
            }
            
            list.innerHTML = results.map(r => {
                const status = r.status;
                const isError = r.error || status == null;
                
                let statusClass = 'error';
                if (!isError) {
                    if (status >= 200 && status < 300) statusClass = 's2xx';
                    else if (status >= 300 && status < 400) statusClass = 's3xx';
                    else if (status >= 400 && status < 500) statusClass = 's4xx';
                    else if (status >= 500) statusClass = 's5xx';
                }
                
                const statusLabel = isError ? 'ERR' : status;
                const isDone = r.itemStatus === 'done';
                
                // Show status change if there was one
                let statusChange = '';
                if (r.previousStatus && r.previousStatus !== status) {
                    const improved = status >= 200 && status < 300 && r.previousStatus >= 400;
                    statusChange = `<span class="status-change ${improved ? 'improved' : ''}">(was ${r.previousStatus})</span>`;
                }
                
                let meta = '';
                if (r.error) meta = r.error;
                else if (r.finalUrl && r.finalUrl !== r.url) meta = `‚Üí ${truncate(r.finalUrl, 40)}`;
                
                return `
                    <div class="result-row ${isDone ? 'done' : ''}" data-id="${r.id}" data-status="${statusClass}" data-item-status="${r.itemStatus || 'pending'}">
                        <input type="checkbox" class="result-checkbox" ${isDone ? 'checked' : ''} onchange="toggleDone('${r.id}', this.checked)" title="Mark as done (will re-check URL)">
                        <span class="result-status ${statusClass}">${statusLabel}</span>${statusChange}
                        <button class="recheck-btn" onclick="recheckUrl('${r.id}')" title="Re-check this URL">‚Üª</button>
                        <span class="result-url"><a href="${escapeHtml(r.url)}" target="_blank">${escapeHtml(r.url)}</a></span>
                        ${meta ? `<span class="result-meta">${escapeHtml(meta)}</span>` : ''}
                        <span class="result-notes">
                            <input type="text" placeholder="Notes..." value="${escapeHtml(r.notes || '')}" onchange="updateNotes('${r.id}', this.value)">
                        </span>
                    </div>
                `;
            }).join('');
        }
        
        function truncate(str, len) {
            if (!str || str.length <= len) return str;
            return str.slice(0, len) + '...';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        async function toggleDone(itemId, isDone) {
            const row = document.querySelector(`.result-row[data-id="${itemId}"]`);
            const checkbox = row?.querySelector('.result-checkbox');
            const statusBadge = row?.querySelector('.result-status');
            
            // Show loading state when marking as done (will re-check URL)
            if (isDone && statusBadge) {
                statusBadge.textContent = '...';
                statusBadge.className = 'result-status';
            }
            if (checkbox) checkbox.disabled = true;
            
            try {
                const response = await fetch(`/api/status-reports/${reportId}/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemStatus: isDone ? 'done' : 'pending' })
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update local data with re-checked status
                    const item = reportData.results.find(r => r.id === itemId);
                    if (item) {
                        Object.assign(item, data.item);
                    }
                    reportData.itemStats = data.itemStats;
                    if (data.summary) reportData.summary = data.summary;
                    
                    // Update status badge with new status
                    const newStatus = data.item.status;
                    const isError = data.item.error || newStatus == null;
                    let statusClass = 'error';
                    if (!isError) {
                        if (newStatus >= 200 && newStatus < 300) statusClass = 's2xx';
                        else if (newStatus >= 300 && newStatus < 400) statusClass = 's3xx';
                        else if (newStatus >= 400 && newStatus < 500) statusClass = 's4xx';
                        else if (newStatus >= 500) statusClass = 's5xx';
                    }
                    
                    if (statusBadge) {
                        statusBadge.textContent = isError ? 'ERR' : newStatus;
                        statusBadge.className = `result-status ${statusClass}`;
                    }
                    
                    // Update row state
                    if (row) {
                        row.classList.toggle('done', isDone);
                        row.dataset.itemStatus = isDone ? 'done' : 'pending';
                        row.dataset.status = statusClass;
                    }
                    
                    // Update summary counters
                    document.getElementById('sumProgress').textContent = `${data.itemStats.done}/${data.itemStats.total}`;
                    if (data.summary) {
                        document.getElementById('sum2xx').textContent = data.summary.s2xx || 0;
                        document.getElementById('sum3xx').textContent = data.summary.s3xx || 0;
                        document.getElementById('sum4xx').textContent = data.summary.s4xx || 0;
                        document.getElementById('sum5xx').textContent = data.summary.s5xx || 0;
                        document.getElementById('sumError').textContent = data.summary.error || 0;
                    }
                    
                    // Show status change notification if status improved
                    if (isDone && data.item.previousStatus && data.item.previousStatus !== newStatus) {
                        showToast(`Status updated: ${data.item.previousStatus} ‚Üí ${newStatus}`, 'success');
                    } else if (isDone) {
                        showToast('Re-checked and marked as done', 'success');
                    }
                }
            } catch (error) {
                showToast('Failed to update status', 'error');
                // Revert checkbox
                if (checkbox) checkbox.checked = !isDone;
            } finally {
                if (checkbox) checkbox.disabled = false;
            }
        }
        
        async function updateNotes(itemId, notes) {
            try {
                await fetch(`/api/status-reports/${reportId}/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
                
                // Update local data
                const item = reportData.results.find(r => r.id === itemId);
                if (item) item.notes = notes;
            } catch (error) {
                // Silent fail for notes
            }
        }
        
        async function recheckUrl(itemId) {
            const row = document.querySelector(`.result-row[data-id="${itemId}"]`);
            const recheckBtn = row?.querySelector('.recheck-btn');
            const statusBadge = row?.querySelector('.result-status');
            
            // Show loading state
            if (statusBadge) {
                statusBadge.textContent = '...';
                statusBadge.className = 'result-status checking';
            }
            if (recheckBtn) recheckBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/status-reports/${reportId}/items/${itemId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recheck: true })
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update local data
                    const item = reportData.results.find(r => r.id === itemId);
                    if (item) Object.assign(item, data.item);
                    if (data.summary) reportData.summary = data.summary;
                    
                    // Update status badge
                    const newStatus = data.item.status;
                    const isError = data.item.error || newStatus == null;
                    let statusClass = 'error';
                    if (!isError) {
                        if (newStatus >= 200 && newStatus < 300) statusClass = 's2xx';
                        else if (newStatus >= 300 && newStatus < 400) statusClass = 's3xx';
                        else if (newStatus >= 400 && newStatus < 500) statusClass = 's4xx';
                        else if (newStatus >= 500) statusClass = 's5xx';
                    }
                    
                    if (statusBadge) {
                        statusBadge.textContent = isError ? 'ERR' : newStatus;
                        statusBadge.className = `result-status ${statusClass}`;
                    }
                    
                    if (row) row.dataset.status = statusClass;
                    
                    // Update summary counters
                    if (data.summary) {
                        document.getElementById('sum2xx').textContent = data.summary.s2xx || 0;
                        document.getElementById('sum3xx').textContent = data.summary.s3xx || 0;
                        document.getElementById('sum4xx').textContent = data.summary.s4xx || 0;
                        document.getElementById('sum5xx').textContent = data.summary.s5xx || 0;
                        document.getElementById('sumError').textContent = data.summary.error || 0;
                    }
                    
                    // Show notification
                    if (data.item.previousStatus && data.item.previousStatus !== newStatus) {
                        showToast(`Status changed: ${data.item.previousStatus} ‚Üí ${newStatus}`, 'success');
                    } else {
                        showToast(`Re-checked: ${newStatus || 'Error'}`, 'info');
                    }
                }
            } catch (error) {
                showToast('Failed to re-check URL', 'error');
                // Restore original status
                const item = reportData.results.find(r => r.id === itemId);
                if (item && statusBadge) {
                    statusBadge.textContent = item.status || 'ERR';
                }
            } finally {
                if (recheckBtn) recheckBtn.disabled = false;
            }
        }
        
        // Filtering
        document.getElementById('filterInput').addEventListener('input', applyFilters);
        document.getElementById('filterStatus').addEventListener('change', applyFilters);
        document.getElementById('filterDone').addEventListener('change', applyFilters);
        
        function applyFilters() {
            const textQuery = document.getElementById('filterInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const doneFilter = document.getElementById('filterDone').value;
            
            const rows = document.querySelectorAll('.result-row');
            rows.forEach(row => {
                const url = row.querySelector('.result-url').textContent.toLowerCase();
                const status = row.dataset.status;
                const itemStatus = row.dataset.itemStatus;
                
                let show = true;
                
                // Text filter
                if (textQuery && !url.includes(textQuery)) {
                    show = false;
                }
                
                // Status filter
                if (statusFilter) {
                    if (statusFilter === '2xx' && status !== 's2xx') show = false;
                    else if (statusFilter === '3xx' && status !== 's3xx') show = false;
                    else if (statusFilter === '4xx' && status !== 's4xx') show = false;
                    else if (statusFilter === '5xx' && status !== 's5xx') show = false;
                    else if (statusFilter === 'error' && status !== 'error') show = false;
                }
                
                // Done filter
                if (doneFilter && itemStatus !== doneFilter) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        // Copy link
        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast('Link copied to clipboard!', 'success');
            });
        });
        
        // Export CSV
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            if (!reportData || !reportData.results) return;
            
            const headers = ['URL', 'Status', 'Final URL', 'Error', 'Done', 'Notes'];
            const rows = reportData.results.map(r => [
                r.url,
                r.status || '',
                r.finalUrl || '',
                r.error || '',
                r.itemStatus === 'done' ? 'Yes' : 'No',
                r.notes || ''
            ]);
            
            const content = [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');
            
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportData.name || 'status-report'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Exported to CSV', 'success');
        });
        
        // Delete report
        document.getElementById('deleteReportBtn').addEventListener('click', async () => {
            if (!confirm('Delete this report? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/status-reports/${reportId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Report deleted', 'success');
                    setTimeout(() => window.location.href = '/', 1000);
                } else {
                    showToast('Failed to delete report', 'error');
                }
            } catch (error) {
                showToast('Failed to delete report', 'error');
            }
        });
        
        // Toast
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' 
                        ? '<polyline points="20,6 9,17 4,12"/>' 
                        : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'}
                </svg>
                <span>${escapeHtml(message)}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
